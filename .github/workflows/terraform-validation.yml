name: Terraform Validation

on:
  pull_request:
    branches: [ main ]
    paths:
      - '**/*.tf'
      - '**/*.tfvars'
      - '**/*.hcl'

# Required for OIDC authentication to AWS
permissions:
  id-token: write
  contents: read
  checks: write  # Required for creating check-runs

env:
  TF_VERSION: '1.9.0'
  TFLINT_VERSION: 'v0.50.3'
  AWS_REGION: 'us-east-1'

jobs:
  gate:
    runs-on: ubuntu-latest
    outputs:
      infra-changed: ${{ steps.changes.outputs.infra }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changes
        id: changes
        uses: dorny/paths-filter@v2
        with:
          filters: |
            infra:
              - 'infrastructure/**'
              - '.github/workflows/terraform-*.yml'
              - '**/*.tf'
              - '**/*.tfvars'
              - '**/*.hcl'

      - name: Create success check for terraform-plan if not needed
        if: steps.changes.outputs.infra != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const checkName = 'terraform-plan';
            const conclusion = 'success';
            
            await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: checkName,
              head_sha: context.sha,
              status: 'completed',
              conclusion: conclusion,
              output: {
                title: 'Terraform plan job skipped',
                summary: 'No infrastructure code changes detected. Terraform plan job marked as successful.',
                text: 'This check was automatically created because no Terraform files were modified.'
              }
            });

      - name: Create success check for tflint if not needed
        if: steps.changes.outputs.infra != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const checkName = 'tflint';
            const conclusion = 'success';
            
            await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: checkName,
              head_sha: context.sha,
              status: 'completed',
              conclusion: conclusion,
              output: {
                title: 'TFLint job skipped',
                summary: 'No infrastructure code changes detected. TFLint job marked as successful.',
                text: 'This check was automatically created because no Terraform files were modified.'
              }
            });

  terraform-plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    environment: dev
    needs: gate
    if: needs.gate.outputs.infra-changed == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials using OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-TerraformValidation

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Format Check
        id: fmt
        run: terraform fmt -check -recursive
        working-directory: ./infrastructure
        continue-on-error: true

      - name: Terraform Init
        id: init
        run: terraform init
        working-directory: ./infrastructure
        env:
          AWS_DEFAULT_REGION: ${{ env.AWS_REGION }}

      - name: Terraform Validate
        id: validate
        run: terraform validate
        working-directory: ./infrastructure

      - name: Terraform Plan
        id: plan
        run: terraform plan -no-color
        working-directory: ./infrastructure
        continue-on-error: true
        env:
          AWS_DEFAULT_REGION: ${{ env.AWS_REGION }}

  tflint:
    name: TFLint
    runs-on: ubuntu-latest
    environment: dev
    needs: gate
    if: needs.gate.outputs.infra-changed == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cache plugin dir
        uses: actions/cache@v4
        with:
          path: ~/.tflint.d/plugins
          key: ${{ runner.os }}-tflint-${{ hashFiles('.tflint.hcl') }}

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: ${{ env.TFLINT_VERSION }}

      - name: Show TFLint version
        run: tflint --version

      - name: Init TFLint
        run: tflint --init

      - name: Run TFLint
        run: tflint -f compact