name: Debug Deployment

on:
  workflow_dispatch:  # Manual trigger only

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY: liatrio-demo-dev-api
  EKS_CLUSTER_NAME: liatrio-demo-dev-eks-xscgoqr8

jobs:
  debug-deploy:
    runs-on: ubuntu-latest
    environment: dev
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials using OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-Debug

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig --region ${{ env.AWS_REGION }} --name ${{ env.EKS_CLUSTER_NAME }}

      - name: Check cluster connectivity
        run: |
          echo "=== CLUSTER INFO ==="
          kubectl cluster-info
          echo ""
          echo "=== NODES ==="
          kubectl get nodes -o wide
          echo ""
          echo "=== SYSTEM PODS ==="
          kubectl get pods -n kube-system
          echo ""

      - name: Check existing deployments
        run: |
          echo "=== EXISTING DEPLOYMENTS ==="
          kubectl get deployments -A
          echo ""
          echo "=== EXISTING PODS ==="
          kubectl get pods -A
          echo ""

      - name: Clean up existing deployment
        run: |
          echo "=== CLEANING UP ==="
          kubectl delete deployment liatrio-demo-api --ignore-not-found=true
          kubectl delete service liatrio-demo-api-service --ignore-not-found=true
          kubectl delete ingress liatrio-demo-api-ingress --ignore-not-found=true
          sleep 10

      - name: Deploy simple test version
        run: |
          # Get latest image
          IMAGE_TAG=$(aws ecr describe-images --repository-name ${{ env.ECR_REPOSITORY }} --query 'sort_by(imageDetails,&imagePushedAt)[-1].imageTags[0]' --output text)
          IMAGE_URI="${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${IMAGE_TAG}"
          
          echo "Using image: ${IMAGE_URI}"
          
          # Use test deployment
          sed "s|IMAGE_URI_PLACEHOLDER|${IMAGE_URI}|g" k8s/test-deployment.yaml > k8s/debug-deployment.yaml
          
          echo "=== DEPLOYMENT MANIFEST ==="
          cat k8s/debug-deployment.yaml
          echo ""
          
          # Apply deployment
          kubectl apply -f k8s/debug-deployment.yaml

      - name: Monitor deployment
        run: |
          echo "=== DEPLOYMENT STATUS ==="
          kubectl get deployment liatrio-demo-api-test
          echo ""
          
          echo "=== WAITING FOR DEPLOYMENT (30s timeout) ==="
          kubectl wait --for=condition=available --timeout=30s deployment/liatrio-demo-api-test || true
          echo ""
          
          echo "=== POD STATUS ==="
          kubectl get pods -l app=liatrio-demo-api-test
          echo ""
          
          echo "=== POD EVENTS ==="
          kubectl get events --field-selector involvedObject.kind=Pod --sort-by='.lastTimestamp'
          echo ""
          
          echo "=== POD LOGS ==="
          kubectl logs -l app=liatrio-demo-api-test --tail=50 || echo "No logs available"
          echo ""
          
          echo "=== POD DESCRIBE ==="
          kubectl describe pods -l app=liatrio-demo-api-test || echo "No pods to describe"