name: Debug API

on:
  workflow_dispatch:  # Manual trigger

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-1

jobs:
  get-infrastructure-info:
    runs-on: ubuntu-latest
    environment: dev
    outputs:
      eks-cluster-name: ${{ steps.terraform-output.outputs.eks_cluster_name }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials using OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-TerraformOutput

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.9.0'
          terraform_wrapper: false

      - name: Get Terraform outputs
        id: terraform-output
        run: |
          cd infrastructure
          terraform init
          EKS_CLUSTER_NAME=$(terraform output -raw eks_cluster_name)
          echo "EKS Cluster Name: $EKS_CLUSTER_NAME"
          echo "eks_cluster_name=$EKS_CLUSTER_NAME" >> $GITHUB_OUTPUT

  debug:
    needs: get-infrastructure-info
    runs-on: ubuntu-latest
    environment: dev
    
    steps:
      - name: Configure AWS credentials using OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-Debug

      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig --region ${{ env.AWS_REGION }} --name ${{ needs.get-infrastructure-info.outputs.eks-cluster-name }}

      - name: Debug deployment
        run: |
          echo "=== Pod Status ==="
          kubectl get pods -l app=liatrio-demo-api-simple -o wide
          
          echo ""
          echo "=== Service Details ==="
          kubectl get service liatrio-demo-api-simple-service -o wide
          kubectl describe service liatrio-demo-api-simple-service
          
          echo ""
          echo "=== Pod Logs ==="
          kubectl logs -l app=liatrio-demo-api-simple --tail=50
          
          echo ""
          echo "=== Pod Describe ==="
          kubectl describe pods -l app=liatrio-demo-api-simple
          
          echo ""
          echo "=== Test from inside cluster ==="
          # Create a test pod to test connectivity from inside the cluster
          kubectl run test-pod --image=curlimages/curl --rm -i --restart=Never -- curl -v http://liatrio-demo-api-simple-service/health
          
          echo ""
          echo "=== Load Balancer Status ==="
          LB_URL=$(kubectl get service liatrio-demo-api-simple-service -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')
          echo "Load balancer URL: $LB_URL"
          
          # Test from GitHub Actions
          echo "Testing from external..."
          curl -v "http://$LB_URL/health" || echo "External test failed"